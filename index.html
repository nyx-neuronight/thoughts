<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portfolio Dashboard — Dark Glassmorphism</title>
  <style>
    :root{
      --bg:#0b0d10;
      --card:#111318aa; /* glass */
      --card-solid:#111318;
      --text:#e5e7eb;
      --muted:#9aa4b2;
      --accent:#5eead4;
      --danger:#f87171;
      --ok:#34d399;
      --border:rgba(255,255,255,.08);
      --glow:0 8px 30px rgba(94,234,212,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% -10%, #1a1f29 0%, #0b0d10 50%),
               radial-gradient(900px 700px at 110% 10%, #12151b 0%, #0b0d10 40%);
      color:var(--text); font: 14px/1.4 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell;
    }
    .container{max-width:1100px; margin:48px auto; padding:0 20px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:20px}
    .title{font-size:20px; font-weight:700; letter-spacing:.3px}
    .row{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .card{backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border:1px solid var(--border); background:var(--card); border-radius:20px; box-shadow:var(--glow)}
    .card-solid{background:var(--card-solid)}
    .card.pad{padding:18px}

    /* P/L aggregate */
    #plCard{grid-column: span 12; display:flex; align-items:center; justify-content:space-between}
    #plCard h2{margin:0; font-size:16px; font-weight:600; color:var(--muted)}
    #plValue{font-size:30px; font-weight:800}
    #roiValue{font-size:12px; color:var(--muted)}

    /* controls */
    .controls{grid-column: span 12; display:flex; gap:10px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid var(--border); color:var(--text); background:linear-gradient(180deg,#151820,#0f1218); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn:hover{border-color:#1f2937}
    .btn.primary{border-color:#1b2a25; background: linear-gradient(180deg,#16302b,#0e1e1a); box-shadow:0 4px 18px rgba(94,234,212,.12)}
    .btn.danger{border-color:#2a1515; background:linear-gradient(180deg,#301616,#1a0e0e)}

    /* table */
    .table-wrap{grid-column: span 12}
    table{width:100%; border-collapse:separate; border-spacing:0 10px}
    thead th{color:var(--muted); font-weight:600; text-align:left; font-size:12px; padding:0 12px}
    tbody tr{background: var(--card); border:1px solid var(--border)}
    tbody tr td{padding:12px}
    tbody tr{border-radius:12px}
    tbody tr td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
    tbody tr td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
    .pill{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted)}
    .pill.stock{color:#93c5fd; border-color:#1e3a8a}
    .pill.option{color:#fca5a5; border-color:#7f1d1d}
    .muted{color:var(--muted)}
    .num{text-align:right; font-variant-numeric:tabular-nums}
    .green{color:var(--ok)} .red{color:var(--danger)}

    /* modal */
    dialog{border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:16px; padding:0; width:min(640px,90vw)}
    dialog::backdrop{background:rgba(0,0,0,.5)}
    .modal-head{padding:16px 18px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center}
    .modal-body{padding:16px 18px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{font-size:12px; color:var(--muted)}
    input,select{width:100%; background:#0c0f14; border:1px solid var(--border); color:var(--text); border-radius:10px; padding:10px; outline:none}
    .hint{font-size:11px; color:var(--muted)}
    .footer{display:flex; justify-content:flex-end; gap:10px; padding:16px 18px; border-top:1px solid var(--border)}

    .note{font-size:11px; color:var(--muted)}
    .badge{font-size:10px; padding:2px 6px; border-radius:6px; border:1px solid var(--border); color:var(--muted)}
    .right{float:right}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">Portfolio Dashboard</div>
      <div class="note">Dark • Glassmorphic • Client-only</div>
    </header>

    <section class="row">
      <div id="plCard" class="card pad">
        <div>
          <h2>Aggregate P/L</h2>
          <div id="roiValue">ROI — <span id="aggRoi">0.00%</span></div>
        </div>
        <div id="plValue" class="num">$0.00</div>
      </div>
      <div class="controls">
        <button class="btn primary" id="addBtn">Add position</button>
        <button class="btn" id="importBtn">Import / Export</button>
        <span class="badge">Auto-refresh <span id="refreshRate">15s</span></span>
        <span class="badge">Source: Polygon.io</span>
        <span class="badge right" id="lastUpdate">—</span>
      </div>

      <div class="table-wrap card pad">
        <table>
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Type</th>
              <th>Side</th>
              <th class="num">Size</th>
              <th class="num">Entry</th>
              <th class="num">Price</th>
              <th class="num">P/L</th>
              <th class="num">ROI</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Add/Edit Modal -->
  <dialog id="posModal">
    <form method="dialog">
      <div class="modal-head">
        <strong id="modalTitle">Add position</strong>
        <button class="btn" value="cancel">Close</button>
      </div>
      <div class="modal-body">
        <div class="grid">
          <div>
            <label>Ticker / Option Symbol</label>
            <input id="mTicker" placeholder="AAPL or O:TSLA241220C00500000" />
            <div class="hint">Stocks: TICKER • Options: Polygon format with <code>O:</code> prefix.</div>
          </div>
          <div>
            <label>Type</label>
            <select id="mType">
              <option value="stock">Stock</option>
              <option value="option">Option</option>
            </select>
          </div>
          <div>
            <label>Side</label>
            <select id="mSide">
              <option value="long">Long</option>
              <option value="short">Short</option>
            </select>
          </div>
          <div id="sizeWrap">
            <label>Size (shares or contracts)</label>
            <input id="mSize" type="number" step="1" min="1" placeholder="100" />
          </div>
          <div>
            <label>Entry Price (per share/contract)</label>
            <input id="mEntry" type="number" step="0.0001" placeholder="123.45" />
          </div>
          <div>
            <label>Notes</label>
            <input id="mNotes" placeholder="optional" />
          </div>
        </div>
      </div>
      <div class="footer">
        <button class="btn" value="cancel">Cancel</button>
        <button class="btn primary" id="saveBtn" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <!-- Import / Export Modal -->
  <dialog id="ioModal">
    <form method="dialog">
      <div class="modal-head">
        <strong>Import / Export</strong>
        <button class="btn" value="cancel">Close</button>
      </div>
      <div class="modal-body">
        <label>JSON</label>
        <textarea id="ioArea" style="width:100%;height:200px;background:#0c0f14;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px"></textarea>
        <div class="hint">Copy to back up. Paste to import. Saved locally in your browser.</div>
      </div>
      <div class="footer">
        <button class="btn" value="cancel">Cancel</button>
        <button class="btn primary" id="ioSave" value="default">Apply</button>
      </div>
    </form>
  </dialog>

  <script>
    // ================== CONFIG ==================
    const POLYGON_API_KEY = localStorage.getItem('POLYGON_API_KEY') || 'YOUR_POLYGON_API_KEY_HERE';
    const REFRESH_MS = 15000; // 15s

    // ================== STATE ==================
    let positions = loadPositions(); // array of { id, ticker, type, side, size, entry, notes }

    // ================== UI BINDINGS ==================
    const rowsEl = document.getElementById('rows');
    const plValueEl = document.getElementById('plValue');
    const aggRoiEl = document.getElementById('aggRoi');
    const lastUpdateEl = document.getElementById('lastUpdate');

    // Buttons
    const posModal = document.getElementById('posModal');
    const ioModal = document.getElementById('ioModal');
    document.getElementById('addBtn').onclick = () => openModal();
    document.getElementById('importBtn').onclick = () => openIOModal();
    document.getElementById('saveBtn').onclick = (e)=>{ e.preventDefault(); savePositionFromModal(); };
    document.getElementById('ioSave').onclick = (e)=>{ e.preventDefault(); applyIO(); };

    // ================== STORAGE ==================
    function loadPositions(){
      try{ return JSON.parse(localStorage.getItem('positions_v1')||'[]'); }catch(e){ return []; }
    }
    function savePositions(){ localStorage.setItem('positions_v1', JSON.stringify(positions)); }

    // ================== MODALS ==================
    function openModal(editId){
      document.getElementById('modalTitle').textContent = editId? 'Edit position' : 'Add position';
      const p = positions.find(x=>x.id===editId) || {ticker:'',type:'stock',side:'long',size:100,entry:'',notes:''};
      document.getElementById('mTicker').value = p.ticker || '';
      document.getElementById('mType').value = p.type || 'stock';
      document.getElementById('mSide').value = p.side || 'long';
      document.getElementById('mSize').value = p.size || 100;
      document.getElementById('mEntry').value = p.entry || '';
      document.getElementById('mNotes').value = p.notes || '';
      posModal.dataset.editId = editId || '';
      posModal.showModal();
    }
    function openIOModal(){
      document.getElementById('ioArea').value = JSON.stringify(positions, null, 2);
      ioModal.showModal();
    }
    function applyIO(){
      try{
        positions = JSON.parse(document.getElementById('ioArea').value || '[]');
        positions = positions.map(p=>({id:p.id||crypto.randomUUID(), ...p}));
        savePositions(); ioModal.close();
        render();
      }catch(e){ alert('Invalid JSON.'); }
    }

    function savePositionFromModal(){
      const ticker = (document.getElementById('mTicker').value||'').trim();
      const type = document.getElementById('mType').value;
      const side = document.getElementById('mSide').value;
      const size = parseInt(document.getElementById('mSize').value||'0',10);
      const entry = parseFloat(document.getElementById('mEntry').value||'0');
      const notes = document.getElementById('mNotes').value||'';
      if(!ticker || !size || !entry){ alert('Please fill ticker, size, and entry.'); return; }
      const editId = posModal.dataset.editId;
      if(editId){
        const i = positions.findIndex(x=>x.id===editId); if(i>-1) positions[i] = { ...positions[i], ticker, type, side, size, entry, notes };
      }else{
        positions.push({ id: crypto.randomUUID(), ticker, type, side, size, entry, notes });
      }
      savePositions(); posModal.close(); render();
    }

    function removePosition(id){
      if(!confirm('Remove this position?')) return;
      positions = positions.filter(p=>p.id!==id); savePositions(); render();
    }

    // ================== DATA: POLYGON ==================
    async function fetchJson(url){
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!r.ok){ throw new Error('HTTP '+r.status); }
      return r.json();
    }

    // Stock latest price via Last Trade endpoint
    async function getStockPrice(ticker){
      const url = `https://api.polygon.io/v2/last/trade/${encodeURIComponent(ticker)}?apiKey=${POLYGON_API_KEY}`;
      const j = await fetchJson(url); // { results: { p: price } }
      const price = j?.results?.p ?? null;
      return price;
    }

    // Option premium via Contract Snapshot; prefer last_trade price, fallback to mid of bid/ask
    async function getOptionPremium(optionSymbol){
      // optionSymbol example: O:TSLA241220C00500000
      const url = `https://api.polygon.io/v3/snapshot/options/${encodeURIComponent(optionSymbol)}?apiKey=${POLYGON_API_KEY}`;
      const j = await fetchJson(url);
      const c = j?.results;
      if(!c) return null;
      const last = c?.last_trade?.price;
      const bid = c?.last_quote?.bid; const ask = c?.last_quote?.ask;
      const mid = (bid && ask) ? (bid+ask)/2 : null;
      return (last ?? mid ?? null);
    }

    // ================== RENDER ==================
    async function render(){
      rowsEl.innerHTML = '<tr><td class="muted" colspan="9">Loading…</td></tr>';
      let aggPL = 0, aggCost = 0;

      const rows = await Promise.all(positions.map(async p=>{
        try{
          const isOpt = p.type === 'option' || /^O:/.test(p.ticker);
          const sym = p.ticker.trim().toUpperCase();
          const size = Number(p.size);
          const entry = Number(p.entry);

          const px = isOpt ? await getOptionPremium(sym) : await getStockPrice(sym);
          const price = Number(px || 0);
          const mult = isOpt ? 100 : 1;
          const dir = p.side === 'short' ? -1 : 1;
          const pl = (price - entry) * size * mult * dir;
          const cost = Math.abs(entry * size * mult);
          const roi = cost ? (pl / cost) * 100 : 0;

          aggPL += pl; aggCost += cost;

          return {
            id:p.id, sym, type: isOpt? 'option':'stock', side:p.side, size, entry, price, pl, roi
          };
        }catch(e){
          return { id:p.id, sym:p.ticker, type:p.type, side:p.side, size:p.size, entry:p.entry, price:NaN, pl:NaN, roi:NaN, err:true };
        }
      }));

      // Update header
      plValueEl.textContent = fmtMoney(aggPL);
      plValueEl.className = 'num ' + (aggPL>=0? 'green':'red');
      const aggROI = aggCost ? (aggPL/aggCost)*100 : 0;
      aggRoiEl.textContent = (isFinite(aggROI)? aggROI:0).toFixed(2)+'%';
      lastUpdateEl.textContent = 'Updated ' + new Date().toLocaleTimeString();

      // Table
      if(!rows.length){ rowsEl.innerHTML = '<tr><td class="muted" colspan="9">No positions. Click “Add position”.</td></tr>'; return; }

      rowsEl.innerHTML = rows.map(r=>{
        const typePill = `<span class="pill ${r.type}">${r.type}</span>`;
        const side = r.side.charAt(0).toUpperCase()+r.side.slice(1);
        const priceStr = isFinite(r.price)? fmtNumber(r.price) : '<span class="muted">—</span>';
        const plClass = r.pl>=0? 'green':'red';
        const plStr = isFinite(r.pl)? `<span class="${plClass}">${fmtMoney(r.pl)}</span>` : '<span class="muted">—</span>';
        const roiStr = isFinite(r.roi)? `<span class="${plClass}">${r.roi.toFixed(2)}%</span>` : '<span class="muted">—</span>';
        return `<tr>
          <td><strong>${escapeHtml(r.sym)}</strong></td>
          <td>${typePill}</td>
          <td>${side}</td>
          <td class="num">${fmtNumber(r.size)}</td>
          <td class="num">${fmtNumber(r.entry)}</td>
          <td class="num">${priceStr}</td>
          <td class="num">${plStr}</td>
          <td class="num">${roiStr}</td>
          <td class="num"><button class="btn" onclick="openModal('${r.id}')">Edit</button> <button class="btn danger" onclick="removePosition('${r.id}')">Remove</button></td>
        </tr>`;
      }).join('');
    }

    // ================== UTILS ==================
    function fmtMoney(x){
      const s = (x||0).toLocaleString(undefined,{style:'currency',currency:'USD',minimumFractionDigits:2});
      return s;
    }
    function fmtNumber(x){
      return Number(x||0).toLocaleString(undefined,{maximumFractionDigits:4});
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    // ================== BOOT ==================
    render();
    setInterval(render, REFRESH_MS);

    // Tip: store your API key locally without hardcoding
    if(POLYGON_API_KEY==='YOUR_POLYGON_API_KEY_HERE'){
      const k = prompt('Enter your Polygon API Key (stored locally)');
      if(k){ localStorage.setItem('POLYGON_API_KEY', k.trim()); location.reload(); }
    }
  </script>

  <!--
    IMPLEMENTATION NOTES
    • Data source:
      - Stocks: GET /v2/last/trade/{ticker}
        Docs: https://polygon.io/docs/rest/stocks/trades-quotes/last-trade
      - Options: GET /v3/snapshot/options/{optionsTicker}
        Docs: https://polygon.io/docs/rest/options/snapshots/option-contract-snapshot
    • Option symbol format (Polygon): O:UNDERLYINGYYMMDD[C|P]SSSSSSSS
      Example: O:TSLA241220C00500000
    • Security: For production, proxy requests via a Cloudflare Worker to keep your key private.
    • Storage: Positions persist in localStorage under 'positions_v1'.
    • Import/Export: Use the JSON modal to bulk add or back up positions.
  -->
</body>
</html>
